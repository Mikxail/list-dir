var fs = require('fs');
var path = require('path');
var express = require('express');
var datetime = require('datetime');
var list = require('./list');
//require("coffee-script");
//var list = require('./list2');
var parser = require('./parser');


var existsSync = path.existsSync || fs.existsSync;

module.exports = {
	listen: function(DIR){
		DIR = path.resolve(DIR);
		if (!existsSync(DIR)) {
			throw new Error('base directory "'+DIR+'" is not exist');
		}
		var list_dir = new list({basePath: DIR});
		var app = express();
		
		app.configure(function(){
			app.use(express.logger('\x1b[33m:method\x1b[0m \x1b[32m:url\x1b[0m :response-time'));
			app.set('view engine', 'ejs');
			//app.use(express.static(DIR));
			app.use(express.errorHandler({dumpExceptions: true, showStack: true}));
		});
		
		app.all('*', function(req, res){
			var requestData = parser(req);
			list_dir.get(requestData.path, requestData.sorts, function(err, data, path){
				if (err) return res.send(500, 'Something went wrong'+err);
				
				if (typeof data == "string") {
					res.sendfile(data);
				} else {
					var viewPath = path.substr(DIR.length);
					res.render('list', {data: data, path: viewPath, dateformat: dateformat, sort: requestData.sorts});
				}
			});
		});
		
		app.listen.apply(app, Array.prototype.slice.call(arguments, 1));
	},
	
	list: list
};

function dateformat(date){
	return datetime.format(date, "%d-%b-%Y %X");
	date = new Date(date);
	return date.toDateString();
	console.log('---dateformat--', arguments);
}